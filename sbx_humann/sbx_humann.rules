rule all_humann:
    input:
        expand(str(ANNOTATION_FP/'humann_output'/'{sample}'/'level4ec-cpm-named.tsv'), sample=Samples.keys())
               
rule run_humann:
    input:
        str(QC_FP/'decontam'/'{sample}_1.fastq.gz')
    output:
        str(ANNOTATION_FP/'humann'/'{sample}')
    shell:
        """
        humann -i {input} -o {output} --nucleotide-database /home/cpat0003/of33_scratch/Shotgun/db/chocophlan --protein-database /home/cpat0003/of33_scratch/Shotgun/db/uniref --metaphlan-options "-t rel_ab --add_viruses --bowtie2_exe /home/cpat0003/miniconda3/bin/bowtie2" --memory-use maximum --threads 100
        """

rule run_debug:
    input:
        str(ANNOTATION_FP/'humann'/'{sample}')
    output:
        str(ANNOTATION_FP/'humann_output'/'{sample}'/'{sample}_1_genefamilies.tsv')
    shell:
        "echo Starting output reshaping..."

rule run_normalise:
    input:
        str(ANNOTATION_FP/'humann_output'/'{sample}'/'{sample}_1_genefamilies.tsv')
    output:
        str(ANNOTATION_FP/'humann_output'/'{sample}'/'{sample}_1_genefamilies-cpm.tsv')
    shell:
        """
        humann_renorm_table --input {input} -o {output} --units cpm --update-snames
        """

rule run_regroup:
    input:
        str(ANNOTATION_FP/'humann_output'/'{sample}'/'{sample}_1_genefamilies-cpm.tsv')
    output:
        str(ANNOTATION_FP/'humann_output'/'{sample}'/'level4ec-cpm.tsv')
    shell:
        """
        humann_regroup_table --input {input} -o {output} --groups uniref90_level4ec
        """

rule run_rename:
    input:
        str(ANNOTATION_FP/'humann_output'/'{sample}'/'level4ec-cpm.tsv')
    output:
        str(ANNOTATION_FP/'humann_output'/'{sample}'/'level4ec-cpm-named.tsv')
    shell:
        """
        humann_rename_table --input {input} -o {output} --names ec
        """
